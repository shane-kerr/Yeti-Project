Background
==========
This document describes the process used to generate and distribute
the Yeti root.

The Yeti DNS Project takes the [IANA root zone][1], and performs
minimal changes needed to serve the zone from the [Yeti root
servers][2] instead of the [IANA root servers][3].

In Yeti, this modified root zone is generated by the Yeti Distribution
Masters (DM), which provide it to the Yeti root servers.

While in principle this could be done by a single DM, Yeti uses a set
of three DM. These DM coordinate their work so that the resulting Yeti
root zone is always consistent. (We need to avoid the case where not
all DM share the same set of Yeti root servers, and so they produce
different versions of the Yeti root zone with the same serial.)


Generation
==========
The generation process is:

1. Download the latest IANA root zone
2. Make modifications to change from the IANA to Yeti root servers
3. Sign the new Yeti root zone
4. Publish the new Yeti root zone

IANA Root Zone
--------------
The root zone is currently downloaded using AXFR from
F.ROOT-SERVERS.NET:

```sh
   $ dig -t axfr . @f.root-servers.net.
```

This appears to be the best way to get the updated version of the root
zone as soon as possible.

TODO: The DM should check that the zone they are retrieving from IANA
is properly signed, with something like ldns-verify-zone.

A new version of the Yeti zone is only generated when the IANA zone
changes, which is detected by the change in the serial number value in
the SOA record.

KSK secret
----------
All DM share the same KSK secret material. This generated using the
BIND 9 dnssec-keygen tool, and then sent via encrypted PGP to the
other DM operators.

Modifications
-------------
The root zone is modified as follows:

* The SOA is updated:
    * The MNAME and RNAME are set to Yeti values
* The IANA DNSSEC information is removed:
    * The DNSKEY records
    * The RRSIG and NSEC records
* The IANA root server records are removed:
    * The NS records for [A-M].ROOT-SERVERS.NET
* The Yeti DNSSEC information is added:
    * The DNSKEY records
* The Yeti root server records are added:
    * The NS records
    * The AAAA glue records
* The Yeti root zone is signed

It might be worthwhile to use the serial value in the SOA field,
however for now we duplicate the IANA serial value.

The list of Yeti name Servers is synchronized between the DM as
described below.

Timing
------
Each Yeti DM checks to see if the IANA root zone has changed hourly,
on the following schedule:

| DM   | Time        |
|------|-------------|
| BII  | _hour_ + 00 |
| WIDE | _hour_ + 20 |
| TISF | _hour_ + 40 |

A new version of the Yeti root zone is generated if the IANA root zone
has changed.

Synchronizing List of Yeti Name Servers
=======================================
It is important that the root zone produced by the Yeti DM is always
consistent. In order to do this, we use something like a 2-phase
commit procedure.

Summary of Process
------------------
One of the Yeti DM starts the process, setting a time for when it
completes. Both of the other Yeti DM confirm the change. If both have
confirmed the change by the deadline, then the update is made.
Otherwise the change fails, and humans figure out what went wrong.

Details of Process
------------------
There are three phases to a change. Start, Acknowledge, and Commit.

1. Start Phase
   One of the Yeti DM begins a change to the list of Yeti name
   servers.  It creates a file into a PENDING directory:

   * The file is named "yeti-root.${DM}" (DM is "bii", "tisf", or
     "wide").
   * The first line of the file is the time when the new list will be
     used.
   * Each additional line of the file is information about one Yeti
     root server, with the name of the server and the IPv6 address.

   A sample file:

```
        # 2015-09-01T08:35:22 (scheduled time list is used)
        bii.dns-lab.net 2001::1
        yeti.tisf.net 2001::2
        yeti-dns.wide.jp 2001::3
```

TODO: use IPv6 documentation addresses

   This file is sent to each of the other Yeti servers using rsync.

   It is possible that two Yeti DM execute the Start phase the process
   independently. If the list of Yeti root servers is the same, this
   is not a problem. If the list of Yeti root servers is different,
   then this an error, and the update fails. Humans must intervene and
   correct the error. The _earliest_ time in all files will be used
   for the scheduled time.

2. Acknowledge Phase
   Each of the Yeti DM confirms that it has seen the new list of Yeti
   root servers, and reports this to the other Yeti DM.

   The report is done by creating a file with the same Yeti root
   servers. So if BII discovers "yeti-root.wide" or "yeti-root.tisf"
   then it will create "yeti-root.bii".

   This file is sent to each of the other Yeti servers using rsync.

3. Commit Phase
   After the scheduled time, each server has one of three possible
   cases:

   1. There is a file for each Yeti DM and they all contain an
      identical list of Yeti root servers. This is expected. We use
      this new list of Yeti root servers.

   2. There are no files for any Yeti DM. The server has not received
      any notification of the new version. Continue to use the old
      version.

   3. There is a new file for some Yeti DM, but not for all. This is
      an error case. *DO NOT* produce any more root zones at all. (It
      is possible that one of the other Yeti DM has all three, and
      will start to use the new list. We cannot know. The only safe
      action is to stop generating root zones.)

Pseudocode
----------
In pseudocode, synchronization may look something like this:

```
sync_yeti_roots:
    loop forever:
        if time() > SCHEDULED_TIME:
            if all_dm_root_list_present_and_identical():
                install_new_root_list()
            else:
                PANIC   # notify a human being

        else:
            if any_root_list_present():
                if new_root_list_identical():
                    add_my_root_list_file()
                    send_my_root_list_file_to_dm()
                else:
                    PANIC    # notify a human being

        sleep a bit
```

Other Notes
-----------
We choose 48 hours as the current time to adopt a new list of Yeti
name servers. This allows plenty of time for for DM administrators to
fix issues.

Only a single PENDING change is possible at one time. This is an
entire new list of Yeti root servers. Further changes must be held
until the current set is applied.

Note that it might be possible to start using the new list of Yeti
name servers as soon as all DM have received it. However for
predictability and simplicity we will always use the scheduled time
for now.

[1]: https://www.iana.org/domains/root
[2]: http://yeti-dns.org/operators.html
[3]: https://www.iana.org/domains/root/servers
